<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="productMapper">
  	<!-- 상품 -->
  	<resultMap type="Product" id="productResult">
  		<result column="PRODUCT_NO" property="productNo"/>
  		<result column="CATEGORY" property="category"/>
  		<result column="PRODUCT_NAME" property="productName"/>
  		<result column="PRODUCT_BRAND" property="productBrand"/>
  		<result column="NORMAL_PRICE" property="normalPrice"/>
  		<result column="SALE_PRICE" property="salePrice"/>
  		<result column="DISCOUNT" property="discountPercent"/>
  		<result column="MAIN_IMG" property="mainImg"/>
  		<result column="DESCRIPTION" property="description"/>
  		<result column="SHIPMENT_TYPE" property="shipmentType"/>
  		<result column="SHIPMENT_TIME" property="shipmentTime"/>
  		<result column="SHIPPING_PRICE" property="shippingPrice"/>
  		<result column="STATUS" property="status"/>
  	</resultMap>
  	
  	<!-- 소옵션 분류 -->
  	<resultMap type="ProductDetailOption" id="productDetailOptionResult">
  		<result column="OPTIONS_NAME_NO" property="detailOptionNo"/>
  		<result column="OPTIONS_NAME" property="detailOptionName"/>
  		<result column="OPTIONS_NORMAL_PRICE" property="detailOptionOriginPrice"/>
  		<result column="OPTIONS_SALE_PRICE" property="detailOptionSaledPrice"/>
  		<result column="OPTIONS_STOCK" property="detailOptionQuantity"/>
  		<result column="STATUS" property="status"/>
  	</resultMap>
  	
  	<!-- 옵션 -->
  	 <resultMap type="ProductOption" id="productOptionResult">
  		<result column="OPTIONS_NAME_NO" property="optionNameNo"/>
  		<result column="PRODUCT_NO" property="productNo"/>
  		<result column="STATUS" property="status"/>
  	</resultMap>
	
	<!-- 리뷰 -->
	<resultMap type="Review" id="reviewResult">
		<result column="review_no" property="reviewNo"/>
		<result column="review_content" property="reviewContent"/>
		<result column="review_create_date" property="reviewCreateDate"/>
		<result column="rating" property="rating"/>
		<result column="review_photo" property="reviewPhoto"/>
		<result column="review_type" property="reviewType"/>
		<result column="status" property="status"/>
		<result column="rcp_no" property="refRecipeNo"/>
		<result column="product_no" property="refProductNo"/>
		<result column="member_no" property="refMemberNo"/>
	</resultMap>
	
	<!-- 문의 -->
	<resultMap type="QnA" id="qnaResult">
		<result column="qna_no" property="qnaNo"/>
		<result column="qna_content" property="qnaContent"/>
		<result column="qna_create_date" property="qnaCreateDate"/>
		<result column="qna_type" property="qnaType"/>
		<result column="qna_photo" property="qnaPhoto"/>
		<result column="status" property="status"/>
		<result column="qna_no2" property="refQnaNo"/>
		<result column="rcp_no" property="refRecipeNo"/>
		<result column="product_no" property="refProductNo"/>
		<result column="member_no" property="writerNo"/>
	</resultMap>
	
	
  	<!-- 상품 추가 -->
  	<!-- 
  	 <insert id="insertProduct" parameterType="Product">
        INSERT INTO PRODUCT (
            CATEGORY,
            PRODUCT_NAME,
            PRODUCT_BRAND,
            NORMAL_PRICE,
            SALE_PRICE,
            DISCOUNT,
            MAIN_IMG,
            DESCRIPTION,
            SHIPMENT_TYPE,
            SHIPMENT_TIME,
            SHIPPING_PRICE
        ) VALUES (
            #{category},
            #{productName},
            #{productBrand},
            #{normalPrice},
            #{salePrice},
            #{discountPercent},
            #{mainImg},
            #{description},
            #{shipmentType},
            #{shipmentTime},
            #{shippingPrice}
        )
    </insert>
     -->
    
    <!--  
    	<select id="insertProduct" resultType="_int">
			SELECT insert_product(
				'${product.category}',
				'${product.productName}',
				'${product.productBrand}',
				${product.normalPrice},
				${product.salePrice},
				${product.discountPercent},
				'${product.mainImg}',
				'${product.description}',
				'${product.shipmentType}',
				${product.shipmentTime},
				${product.shippingPrice},
				'${productOption.detailOptionName}',
				${productOption.detailOptionPrice},
				${productOption.detailOptionQuantity})
		</select>
     --> 
     
     <!-- 상품 추가 -->
     <select id="insertProduct" resultMap="productResult">
     	INSERT INTO PRODUCT (
     		PRODUCT_NO,
            CATEGORY,
            PRODUCT_NAME,
            PRODUCT_BRAND,
            NORMAL_PRICE,
            SALE_PRICE,
            DISCOUNT,
            MAIN_IMG,
            DESCRIPTION,
            SHIPMENT_TYPE,
            SHIPMENT_TIME,
            SHIPPING_PRICE
        ) VALUES (
        	nextval('product_product_no_seq'),
            #{category},
            #{productName},
            #{productBrand},
            #{normalPrice},
            #{salePrice},
            #{discountPercent},
            #{mainImg},
            #{description},
            #{shipmentType},
            #{shipmentTime},
            #{shippingPrice}
        ) RETURNING *
     </select>
     
     <!-- 상세옵션 추가 -->
     <select id="insertDetailOption" resultMap="productDetailOptionResult">
     	INSERT INTO OPTION_NAME (
     		OPTIONS_NAME,
     		OPTIONS_NORMAL_PRICE,
     		OPTIONS_SALE_PRICE,
     		OPTIONS_STOCK
     	) VALUES (
			#{detailOptionName},
			#{detailOptionOriginPrice},
			#{detailOptionSaledPrice},
			#{detailOptionQuantity}
  		) RETURNING *
     </select>
     
     <!-- 옵션 추가 -->
     <insert id="insertOptions">
     	INSERT INTO PRODUCT_OPTIONS (
     		PRODUCT_NO,
     		OPTIONS_NAME_NO
     	) VALUES 
     	<foreach collection="optionNoList" item="optionNo" separator=",">
     		(
     			#{productNo},
     			#{optionNo}	
     		)
     	
     	</foreach>
     </insert>

    
    <!-- 가장 많이 팔린 상품 조회 -->
    <select id="selectBestSellerList" resultMap="productResult">
    	SELECT
    		PRODUCT_NO,
    		PRODUCT_NAME,
    		PRODUCT_BRAND,
    		NORMAL_PRICE,
    		SALE_PRICE,
    		DISCOUNT,
    		MAIN_IMG
    	FROM PRODUCT
    	WHERE STATUS = 'Y'
    	ORDER BY SCRAP_COUNT DESC
    	LIMIT 4
    </select>
    
    <!-- 최근 입고된 상품 조회 -->
    <select id="selectRecentProductList" resultMap="productResult">
    	SELECT
    		PRODUCT_NO,
    		PRODUCT_NAME,
    		PRODUCT_BRAND,
    		NORMAL_PRICE,
    		SALE_PRICE,
    		DISCOUNT,
    		MAIN_IMG
    	FROM PRODUCT
    	WHERE STATUS = 'Y'
    	ORDER BY PRODUCT_DATE DESC
    	LIMIT 4
    </select>
    
    <!-- 
    <select id="selectProductCount" resultType="_int">
    	SELECT COUNT(*)
    	FROM PRODUCT
    	WHERE STATUS = 'Y'
    </select>
     -->
     
     <!-- 상품 번호로 상품 조회 -->
     <select id="selectProductByProductNo" resultMap="productResult">
       SELECT 
     		PRODUCT_NO,
     		CATEGORY,
     		PRODUCT_NAME,
     		PRODUCT_BRAND,
     		NORMAL_PRICE,
     		SALE_PRICE,
     		DISCOUNT,
     		MAIN_IMG,
     		DESCRIPTION,
     		SHIPMENT_TYPE,
     		SHIPMENT_TIME,
     		SHIPPING_PRICE
     	FROM PRODUCT
     	WHERE 
     		PRODUCT_NO = #{productNo} AND
     		STATUS = 'Y'
     </select>
  
     
     <select id="selectProductCount" resultType="_int">	
     	SELECT COUNT(*)
     	FROM (
     		SELECT *
	    	FROM PRODUCT
	    	WHERE STATUS = 'Y'
	    		<if test='category == "야채"'>
	    			AND CATEGORY LIKE '야채'
	    		</if>
	    		<if test='category == "과일"'>
	    			AND CATEGORY LIKE '과일'
	    		</if>
	    		<if test='category == "어류"'>
	    			AND CATEGORY LIKE '어류'
	    		</if>
	    		<if test='category == "육류"'>
	    			AND CATEGORY LIKE '육류'
	    		</if>
	    		<if test='category == "빵"'>
	    			AND CATEGORY LIKE '빵'
	    		</if>
	    		<if test='category == "면"'>
	    			AND CATEGORY LIKE '면'
	    		</if>
	    		<if test='category == "유제품"'>
	    			AND CATEGORY LIKE '유제품'
	    		</if>
	    	<if test='sort == "new"'>
	    		ORDER BY PRODUCT_DATE
	    	</if>
	    	<if test='sort == "view"'>
	    		ORDER BY PRODUCT_VIEW
	    	</if>
	    	<if test='sort == "scrap"'>
	    		ORDER BY SCRAP_COUNT
	    	</if>
     	)
     </select>
     
     
     <!-- 조회결과 가져오기 -->
     <select id="selectResultProductList" resultMap="productResult">
     	SELECT 
     		PRODUCT_NO,
     		PRODUCT_NAME,
     		PRODUCT_BRAND,
     		NORMAL_PRICE,
     		SALE_PRICE,
     		DISCOUNT,
     		MAIN_IMG
     	FROM PRODUCT
     	WHERE STATUS = 'Y' 
	     	<if test='category == "야채"'>
	   			AND CATEGORY LIKE '야채'
	   		</if>
	   		<if test='category == "과일"'>
	   			AND CATEGORY LIKE '과일'
	   		</if>
	   		<if test='category == "어류"'>
	   			AND CATEGORY LIKE '어류'
	   		</if>
	   		<if test='category == "육류"'>
	   			AND CATEGORY LIKE '육류'
	   		</if>
	   		<if test='category == "빵"'>
	   			AND CATEGORY LIKE '빵'
	   		</if>
	   		<if test='category == "면"'>
	   			AND CATEGORY LIKE '면'
	   		</if>
	   		<if test='category == "유제품"'>
	   			AND CATEGORY LIKE '유제품'
	   		</if>
	   	<if test='sort == "new"'>
	   		ORDER BY PRODUCT_DATE
	   	</if>
	   	<if test='sort == "view"'>
	   		ORDER BY PRODUCT_VIEW
	   	</if>
	   	<if test='sort == "scrap"'>
	   		ORDER BY SCRAP_COUNT
	   	</if>
     </select>
    
    <!-- 상품 리뷰 조회 -->
    <select id="selectProductReviewsByPno" resultMap="reviewResult">
    	SELECT
    		review_no,
    		review_content,
    		review_create_date,
    		rating,
    		review_photo,
    		review_type,
    		R.member_no,
    		member_nickname as "writerNickname",
    		member_profile as "writerProfile"
    	FROM REVIEW R
    	JOIN MEMBER USING (MEMBER_NO)
    	WHERE
    		product_no = #{productNo} and
    		status = 'Y'
    </select>
    

    <!-- 상품 문의 조회 -->
    <select id="selectProductQnAsByPno" resultMap="qnaResult">
    	select
    		qna_no,
    		qna_content,
    		qna_create_date,
    		qna_type,
    		qna_photo,
    		qna_no2,
    		product_no,
    		member_no,
    		member_nickname as "writerNickname",
    		member_profile as "writerProfile"
    	FROM QNA
 		JOIN MEMBER USING (MEMBER_NO)
 		WHERE product_no = #{productNo} and
 			  status = 'Y'
    </select>
    


	<!-- 상품 전체 개수 조회 -->
	<select id="selectAllProductQuantity" resultType="_int">
		SELECT COUNT(*)
		FROM PRODUCT
	</select>

    

  
  </mapper>